name: Deploy Supabase Edge Functions

on:
    push:
        branches:
            - main # Deploy when pushing to main branch
        paths:
            - "supabase/functions/**" # Only trigger when Edge Functions change
            - ".github/workflows/deploy-functions.yml" # Also trigger if workflow changes

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Supabase CLI
              run: |
                  # Clean up any existing files
                  rm -f supabase supabase.tar.gz
                  # Download and install Supabase CLI
                  curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz -o supabase.tar.gz
                  tar -xzf supabase.tar.gz
                  sudo mv supabase /usr/local/bin/
                  rm -f supabase.tar.gz
                  supabase --version

            - name: Deploy Edge Functions
              env:
                  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
                  SUPABASE_PROJECT_ID: knftyqkhampkqchoncel
              run: |
                  # Login to Supabase using access token
                  echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token -

                  # Link to project
                  supabase link --project-ref $SUPABASE_PROJECT_ID

                  # Deploy all Edge Functions
                  supabase functions deploy send-submission-email --no-verify-jwt
                  supabase functions deploy send-approval-email --no-verify-jwt
                  supabase functions deploy send-rejection-email --no-verify-jwt

                  echo "âœ… All Edge Functions deployed successfully!"
